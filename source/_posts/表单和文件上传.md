---
title: 表单和文件上传
date: 2021-04-27 16:34:48
tags: [HTML,JavaScript]
categories: [笔记,前端]
---
#### 原生表单文件上传

在HTML表单里，上传文件的唯一控件：`<input type="file">`

完整的格式如下：

```html
<form enctype="multipart/form-data" method="post" action="...">
	<input type="file" name="file" />
	<input type="submit" value="上传" />
</form>
```

这里有几个注意点：

- form必须设置成 `enctype="multipart/form-data" method="post"`
- 控件必须设置name属性

multipart/form-data，表示传输数据为<u>二进制类型</u>，由此可以传输多种类型的文件；使用post则是因为get有大小限制

##### 一些有用的属性

- accept：允许的文件类型，多个类型用逗号分开

  格式如“分类名/后缀”，比如 `image/jpg,image/png`, `video/*`
  也可以简写，比如`.png,.jpeg,.jpg,.pdf`，要有 `.`

- multiple：布尔值，表示是否多选，即是否可以选择多个文件

- files：即所选择的文件<u>列表</u>

#### Ajax异步上传文件

Ajax（异步JavaScript和XML），它的技术核心就是**XMLHttpRequest（XHR）**对象，我们利用它配合XMLHttpRequest 2级规范定义的**FormData**类型来实现文件的上传

FormData类型有一个 append() 方法，它能把数据以<u>键值对</u>的形式塞进FormData的实例里，XHR有一个send()方法，用于把FormData实例发送出去

我们上传文件，简单的说就是以下几步：

1. 通过表单的`<input type="file">`选择我们要上传的文件
2. 通过表单拿到文件，把它包装成FormData，也就是把数据放进一个FormData实例里
3. 用XHR的send()方法，把这个FormData实例发送出去

```html
<input id="file" type="file">
<button id="btn">上传</button>
```

```javascript
var btn = document.getElementById("btn");
var file = document.getElementById("file");
btn.onclick = function(){
  // 获取文件
  var fileToUpload = file.files[0];
  var formData = new FormData();
  formData.append('file', fileToUpload);

  var xhr = new XMLHttpRequest();
  // xhr.setRequestHeader("Content-type", "multipart/form-data")
  // 配置响应
  xhr.onreadystatechange = function(){
    if(xhr.readyState == 4){
      if(xhr.status >= 200 && xhr.status < 300 || xhr.status == 304){
        // 成功
        alert(xhr.responseText)
      }else{
        // 失败
      }
    }
  }

  // 启动请求，发送请求
  xhr.open('POST','url',true);  // 第一个参数指定为POST，第三个参数指定为true，表示异步
  xhr.send(formData)
}
```

这种上传是以<u>二进制</u>的格式传输的。此外，XHR还提供了超时设定，进度事件，跨域等功能，帮助我们更好地处理文件上传问题

#### 大文件分片上传

上面的方法在大多数情况下没有什么问题。但是在上传大文件时一旦中断就只能重新上传，从头来过，让人头疼。而分片上传的意义在于**把一个文件分成多份，一片片的上传**，<u>当某一片上传失败时可以记录下来，进行重传或者其他处理</u>。

根据预先设置好的切片大小将文件切分为一个个切片，然后借助HTTP 的可并发性，同时上传多个切片，这样从原本传一个大文件，变成了同时传多个小的文件切片，可以大大减少上传时间。另外由于是并发，传输到服务端的顺序可能会发生变化，所以我们还需要给每个切片记录顺序。

文件切片，我们使用Blob.prototype.slice()方法

```javascript
function commit(){
  var BYTES_PER_SLICE = 1 * 1024 * 1024  // 设置每个切片大小,这里是1M
  var file = document.getElementById("file").files[0];
  var totalSize = file.size;  // 文件大小，字节数
  var fileName = file.name;

  // 计算文件切片总数（向上取整）
  var totalSlices = Math.ceil(file.size / BYTES_PER_SLICE);
  // 循环将切片上传
  var start,end; // 分片的开始、结束（不含）
  var index = 0;  // 初始化当前传输的切片
  while(index < totalSlices) {
    start = index * BYTES_PER_SLICE;
    end = start + BYTES_PER_SLICE;

    var slice = file.slice(start,end); // 切割文件
    uploadFile(slice, index++,fileName);
  }
}

//上传文件
function uploadFile(slice, index, fileName) {
  var formData = new FormData();
  formDate.append("slice", slice);
  formDate.append("fileName",fileName);
  formDate.append("index",index);

  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'url', true);
  xhr.onreadystatechange = function(){ ... }
  xhr.send(formData);
}
```

#### 参考

[字节跳动面试官：请你实现一个大文件上传和断点续传 (juejin.cn)](https://juejin.cn/post/6844904046436843527#heading-24)

[文件分片上传_炫封的博客-CSDN博客](https://blog.csdn.net/weixin_37891479/article/details/80842421)

